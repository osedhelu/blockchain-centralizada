<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blockchain Explorer - Estilo Binance</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);
            color: #eaecef;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: rgba(26, 31, 58, 0.8);
            backdrop-filter: blur(10px);
            padding: 20px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 30px;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            background: linear-gradient(135deg, #f0b90b 0%, #f8d33a 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .tab {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            color: #eaecef;
            font-weight: 500;
        }

        .tab:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: #f0b90b;
        }

        .tab.active {
            background: linear-gradient(135deg, #f0b90b 0%, #f8d33a 100%);
            color: #0a0e27;
            border-color: #f0b90b;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: rgba(26, 31, 58, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #f0b90b;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(26, 31, 58, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
        }

        .stat-label {
            font-size: 14px;
            color: #8a8fa3;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #eaecef;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-label {
            display: block;
            margin-bottom: 8px;
            color: #8a8fa3;
            font-size: 14px;
            font-weight: 500;
        }

        .input-field {
            width: 100%;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #eaecef;
            font-size: 14px;
            transition: all 0.3s;
        }

        .input-field:focus {
            outline: none;
            border-color: #f0b90b;
            background: rgba(255, 255, 255, 0.08);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #f0b90b 0%, #f8d33a 100%);
            color: #0a0e27;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(240, 185, 11, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #eaecef;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .wallet-info {
            background: rgba(240, 185, 11, 0.1);
            border: 1px solid rgba(240, 185, 11, 0.3);
            border-radius: 8px;
            padding: 16px;
            margin-top: 20px;
        }

        .wallet-address {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            word-break: break-all;
            color: #f0b90b;
            margin: 10px 0;
        }

        .balance-display {
            font-size: 32px;
            font-weight: bold;
            color: #f0b90b;
            margin: 20px 0;
        }

        .transaction-item {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .transaction-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .tx-amount {
            font-size: 18px;
            font-weight: 600;
        }

        .tx-amount.sent {
            color: #f6465d;
        }

        .tx-amount.received {
            color: #0ecb81;
        }

        .tx-details {
            font-size: 12px;
            color: #8a8fa3;
            margin-top: 4px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #8a8fa3;
        }

        .error {
            background: rgba(246, 70, 93, 0.1);
            border: 1px solid rgba(246, 70, 93, 0.3);
            color: #f6465d;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .success {
            background: rgba(14, 203, 129, 0.1);
            border: 1px solid rgba(14, 203, 129, 0.3);
            color: #0ecb81;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .block-item {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .block-item:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: #f0b90b;
        }

        .block-item.expanded {
            background: rgba(255, 255, 255, 0.06);
        }

        .block-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .block-expand-btn {
            background: rgba(240, 185, 11, 0.2);
            border: 1px solid #f0b90b;
            color: #f0b90b;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
            transition: all 0.3s;
        }

        .block-expand-btn:hover {
            background: rgba(240, 185, 11, 0.3);
        }

        .block-transactions {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: none;
        }

        .block-item.expanded .block-transactions {
            display: block;
        }

        .transaction-detail {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
        }

        .tx-hash {
            font-family: 'Courier New', monospace;
            font-size: 11px;
            color: #8a8fa3;
            word-break: break-all;
            margin: 8px 0;
        }

        .tx-info-row {
            display: flex;
            justify-content: space-between;
            margin: 6px 0;
            font-size: 13px;
        }

        .tx-label {
            color: #8a8fa3;
        }

        .tx-value {
            color: #eaecef;
            font-weight: 500;
        }

        .block-hash {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #8a8fa3;
            word-break: break-all;
        }

        .copy-btn {
            padding: 6px 12px;
            font-size: 12px;
            margin-left: 10px;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .nav-tabs {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <div>
                <div class="logo">üîó Blockchain Explorer</div>
                <div class="nav-tabs">
                    <div class="tab active" onclick="switchTab('explorer')">Explorador</div>
                    <div class="tab" onclick="switchTab('wallet')">Wallet</div>
                    <div class="tab" onclick="switchTab('blocks')">Bloques</div>
                    <div class="tab" onclick="switchTab('metamask')">MetaMask</div>
                </div>
                <div id="wallet-status" style="margin-left: 20px; padding: 8px 16px; background: rgba(240, 185, 11, 0.2); border: 1px solid #f0b90b; border-radius: 6px; font-size: 12px;">
                    <span id="wallet-connected">No conectado</span>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Tab: Explorador -->
        <div id="explorer" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Bloques Totales</div>
                    <div class="stat-value" id="total-blocks">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Transacciones Pendientes</div>
                    <div class="stat-value" id="pending-tx">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Estado de la Cadena</div>
                    <div class="stat-value" id="chain-status">-</div>
                </div>
            </div>

            <div class="card">
                <div class="card-title">Buscar Direcci√≥n</div>
                <div class="input-group">
                    <input type="text" id="search-address" class="input-field" placeholder="0x...">
                </div>
                <button class="btn btn-primary" onclick="searchAddress()">Buscar</button>
                <div id="address-result"></div>
            </div>

            <div class="card">
                <div class="card-title">Buscar Transacci√≥n por Hash</div>
                <div class="input-group">
                    <input type="text" id="search-tx-hash" class="input-field" placeholder="Hash de la transacci√≥n...">
                </div>
                <button class="btn btn-primary" onclick="searchTransactionByHash()">Buscar Transacci√≥n</button>
                <div id="tx-hash-result"></div>
            </div>
        </div>

        <!-- Tab: Wallet -->
        <div id="wallet" class="tab-content">
            <div class="card">
                <div class="card-title">Generar Nueva Wallet</div>
                <button class="btn btn-primary" onclick="generateWallet()">Generar Wallet</button>
                <div id="wallet-result"></div>
            </div>

            <div class="card">
                <div class="card-title">Importar Wallet desde Mnemonic</div>
                <div class="input-group">
                    <label class="input-label">Mnemonic (12 palabras)</label>
                    <input type="text" id="import-mnemonic" class="input-field" placeholder="palabra1 palabra2 ... palabra12">
                </div>
                <div class="input-group">
                    <label class="input-label">√çndice de cuenta (default: 0)</label>
                    <input type="number" id="account-index" class="input-field" value="0" min="0">
                </div>
                <button class="btn btn-primary" onclick="importWallet()">Importar Wallet</button>
                <div id="import-result"></div>
            </div>

            <div class="card">
                <div class="card-title">Consultar Balance</div>
                <div class="input-group">
                    <label class="input-label">Direcci√≥n de la Wallet</label>
                    <input type="text" id="balance-address" class="input-field" placeholder="0x...">
                </div>
                <button class="btn btn-primary" onclick="checkBalance()">Consultar Balance</button>
                <div id="balance-result"></div>
            </div>

            <div class="card">
                <div class="card-title">Transacciones de la Wallet</div>
                <div class="input-group">
                    <label class="input-label">Direcci√≥n de la Wallet</label>
                    <input type="text" id="tx-address" class="input-field" placeholder="0x...">
                </div>
                <button class="btn btn-primary" onclick="getTransactions()">Ver Transacciones</button>
                <div id="transactions-result"></div>
            </div>
        </div>

        <!-- Tab: Bloques -->
        <div id="blocks" class="tab-content">
            <div class="card">
                <div class="card-title">√öltimos Bloques</div>
                <button class="btn btn-secondary" onclick="loadBlocks()">Actualizar</button>
                <div id="blocks-list"></div>
            </div>
        </div>

        <!-- Tab: MetaMask -->
        <div id="metamask" class="tab-content">
            <div class="card">
                <div class="card-title">Conectar MetaMask</div>
                <div id="metamask-status" style="margin-bottom: 20px;">
                    <div class="stat-label">Estado:</div>
                    <div id="connection-status" class="stat-value">No conectado</div>
                </div>
                <button class="btn btn-primary" onclick="connectMetaMask()" id="connect-btn" disabled>Conectar MetaMask</button>
                <button class="btn btn-secondary" onclick="disconnectMetaMask()" id="disconnect-btn" style="display: none; margin-left: 10px;">Desconectar</button>
                <div id="connection-error" style="margin-top: 10px; display: none;"></div>
                <div id="metamask-info" style="margin-top: 20px;"></div>
            </div>

            <div class="card" id="authenticated-actions" style="display: none;">
                <div class="card-title">Operaciones con tu Wallet</div>
                
                <div style="margin-bottom: 20px;">
                    <div class="stat-label">Mi Balance</div>
                    <button class="btn btn-secondary" onclick="getMyBalance()">Consultar Balance</button>
                    <div id="my-balance-result" style="margin-top: 10px;"></div>
                </div>

                <div style="margin-bottom: 20px;">
                    <div class="card-title" style="font-size: 16px; margin-bottom: 10px;">Transferir Fondos</div>
                    <div class="input-group">
                        <label class="input-label">Direcci√≥n Destinataria</label>
                        <input type="text" id="transfer-recipient" class="input-field" placeholder="0x...">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Monto</label>
                        <input type="number" step="0.000000000000000001" id="transfer-amount" class="input-field" placeholder="0.0">
                    </div>
                    <button class="btn btn-primary" onclick="transferFunds()">Transferir</button>
                    <div id="transfer-result" style="margin-top: 10px;"></div>
                </div>

                <div>
                    <div class="card-title" style="font-size: 16px; margin-bottom: 10px;">Mis Transacciones</div>
                    <button class="btn btn-secondary" onclick="getMyTransactions()">Ver Mis Transacciones</button>
                    <div id="my-transactions-result" style="margin-top: 10px;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let authToken = null;
        let connectedAddress = null;
        let isConnecting = false; // Bandera para prevenir m√∫ltiples conexiones simult√°neas

        // Verificar si hay token guardado
        window.addEventListener('DOMContentLoaded', () => {
            const savedToken = localStorage.getItem('auth_token');
            const savedAddress = localStorage.getItem('wallet_address');
            if (savedToken && savedAddress) {
                authToken = savedToken;
                connectedAddress = savedAddress;
                updateWalletStatus();
            }
            
            // Verificar si MetaMask est√° disponible
            checkMetaMaskAvailable();
        });

        function checkMetaMaskAvailable() {
            if (typeof window.ethereum === 'undefined') {
                const connectBtn = document.getElementById('connect-btn');
                if (connectBtn) {
                    connectBtn.disabled = true;
                    connectBtn.textContent = 'MetaMask no instalado';
                    connectBtn.style.opacity = '0.5';
                }
            }
        }
        
        // Funci√≥n para convertir wei (entero) a formato legible con 18 decimales
        function formatWei(wei) {
            if (!wei) return '0';
            const weiStr = wei.toString();
            if (weiStr === '0') return '0';
            
            // Convertir a BigInt para manejar n√∫meros grandes
            const weiBigInt = BigInt(weiStr);
            const divisor = BigInt('1000000000000000000'); // 10^18
            
            const wholePart = weiBigInt / divisor;
            const fractionalPart = weiBigInt % divisor;
            
            if (fractionalPart === 0n) {
                return wholePart.toString();
            }
            
            // Formatear la parte fraccional con 18 d√≠gitos, eliminando ceros finales
            const fractionalStr = fractionalPart.toString().padStart(18, '0').replace(/0+$/, '');
            const result = fractionalStr ? `${wholePart}.${fractionalStr}` : wholePart.toString();
            
            // Eliminar punto decimal si no hay parte fraccional
            return result.endsWith('.') ? result.slice(0, -1) : result;
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'explorer') {
                loadChainInfo();
            } else if (tabName === 'blocks') {
                loadBlocks();
            }
        }

        async function loadChainInfo() {
            try {
                const response = await fetch(`${API_BASE}/chain/info`);
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                const data = await response.json();
                document.getElementById('total-blocks').textContent = data.length || 0;
                document.getElementById('pending-tx').textContent = data.pending_transactions || 0;
                document.getElementById('chain-status').textContent = data.is_valid ? '‚úì V√°lida' : '‚úó Inv√°lida';
            } catch (error) {
                console.error('Error cargando info:', error);
                document.getElementById('total-blocks').textContent = 'Error';
                document.getElementById('pending-tx').textContent = 'Error';
                document.getElementById('chain-status').textContent = '‚úó Error';
            }
        }

        async function searchAddress() {
            const address = document.getElementById('search-address').value.trim();
            if (!address) {
                alert('Por favor ingresa una direcci√≥n');
                return;
            }

            try {
                const [balanceRes, txRes] = await Promise.all([
                    fetch(`${API_BASE}/wallet/${address}/balance`),
                    fetch(`${API_BASE}/wallet/${address}/transactions`)
                ]);

                const balance = await balanceRes.json();
                const transactions = await txRes.json();

                document.getElementById('address-result').innerHTML = `
                    <div class="wallet-info">
                        <div class="stat-label">Direcci√≥n</div>
                        <div class="wallet-address">${balance.address}</div>
                        <div class="stat-label">Balance</div>
                        <div class="balance-display">${balance.balance_formatted || formatWei(balance.balance)}</div>
                        <div class="stat-label">Total de Transacciones</div>
                        <div class="stat-value">${transactions.count}</div>
                    </div>
                `;
            } catch (error) {
                document.getElementById('address-result').innerHTML = 
                    `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function generateWallet() {
            try {
                const response = await fetch(`${API_BASE}/wallet/generate`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({account_index: 0})
                });
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('wallet-result').innerHTML = `
                        <div class="wallet-info">
                            <div class="success">‚úì Wallet generada exitosamente</div>
                            <div class="stat-label">Direcci√≥n</div>
                            <div class="wallet-address">${data.wallet.address}</div>
                            <div class="stat-label">Mnemonic (12 palabras)</div>
                            <div class="wallet-address">${data.wallet.mnemonic}</div>
                            <div class="stat-label">Ruta de Derivaci√≥n</div>
                            <div class="wallet-address">${data.wallet.derivation_path}</div>
                            <div style="margin-top: 20px; padding: 12px; background: rgba(246, 70, 93, 0.1); border-radius: 8px; color: #f6465d;">
                                ‚ö†Ô∏è IMPORTANTE: Guarda el mnemonic de forma segura. No lo compartas con nadie.
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('wallet-result').innerHTML = 
                    `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function importWallet() {
            const mnemonic = document.getElementById('import-mnemonic').value.trim();
            const accountIndex = parseInt(document.getElementById('account-index').value) || 0;
            
            if (!mnemonic) {
                alert('Por favor ingresa el mnemonic');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/wallet/import`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({mnemonic, account_index: accountIndex})
                });
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('import-result').innerHTML = `
                        <div class="wallet-info">
                            <div class="success">‚úì Wallet importada exitosamente</div>
                            <div class="stat-label">Direcci√≥n</div>
                            <div class="wallet-address">${data.wallet.address}</div>
                            <div class="stat-label">Balance</div>
                            <div class="balance-display">${formatWei(data.wallet.balance)}</div>
                            <div class="stat-label">Ruta de Derivaci√≥n</div>
                            <div class="wallet-address">${data.wallet.derivation_path}</div>
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('import-result').innerHTML = 
                    `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function checkBalance() {
            const address = document.getElementById('balance-address').value.trim();
            if (!address) {
                alert('Por favor ingresa una direcci√≥n');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/wallet/${address}/balance`);
                const data = await response.json();
                
                document.getElementById('balance-result').innerHTML = `
                    <div class="wallet-info">
                        <div class="stat-label">Direcci√≥n</div>
                        <div class="wallet-address">${data.address}</div>
                        <div class="stat-label">Balance</div>
                        <div class="balance-display">${data.balance_formatted || formatWei(data.balance)}</div>
                    </div>
                `;
            } catch (error) {
                document.getElementById('balance-result').innerHTML = 
                    `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function getTransactions() {
            const address = document.getElementById('tx-address').value.trim();
            if (!address) {
                alert('Por favor ingresa una direcci√≥n');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/wallet/${address}/transactions`);
                const data = await response.json();
                
                if (data.transactions.length === 0) {
                    document.getElementById('transactions-result').innerHTML = 
                        '<div class="loading">No hay transacciones para esta direcci√≥n</div>';
                    return;
                }

                let html = `<div style="margin-top: 20px;"><div class="stat-label">Total: ${data.count} transacciones</div>`;
                data.transactions.forEach(tx => {
                    const amountClass = tx.type === 'sent' ? 'sent' : 'received';
                    const sign = tx.type === 'sent' ? '-' : '+';
                    html += `
                        <div class="transaction-item">
                            <div>
                                <div class="tx-amount ${amountClass}">${sign}${formatWei(tx.amount)}</div>
                                <div class="tx-details">
                                    ${tx.type === 'sent' ? 'Para: ' + tx.recipient : 'De: ' + tx.sender}
                                    <br>Bloque: ${tx.block_index} | ${new Date(tx.timestamp).toLocaleString()}
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                document.getElementById('transactions-result').innerHTML = html;
            } catch (error) {
                document.getElementById('transactions-result').innerHTML = 
                    `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function loadBlocks() {
            try {
                const response = await fetch(`${API_BASE}/chain`);
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                const data = await response.json();
                
                if (!data.chain || data.chain.length === 0) {
                    document.getElementById('blocks-list').innerHTML = 
                        '<div class="loading">No hay bloques a√∫n</div>';
                    return;
                }

                let html = `<div style="margin-top: 20px;"><div class="stat-label">Total: ${data.chain.length} bloques</div>`;
                data.chain.slice().reverse().forEach((block, idx) => {
                    const blockId = `block-${block.index}`;
                    html += `
                        <div class="block-item" id="${blockId}" onclick="toggleBlock(${block.index})">
                            <div class="block-header">
                                <div style="flex: 1;">
                                    <strong>Bloque #${block.index}</strong>
                                    <div class="block-hash">Hash: ${block.hash}</div>
                                    <div class="tx-details" style="margin-top: 8px;">
                                        Transacciones: ${block.transactions.length} | 
                                        Nonce: ${block.nonce} | 
                                        ${new Date(block.timestamp).toLocaleString()}
                                    </div>
                                </div>
                                <div>
                                    <button class="block-expand-btn" onclick="event.stopPropagation(); toggleBlock(${block.index})">
                                        <span id="expand-icon-${block.index}">‚ñº</span> Ver Transacciones
                                    </button>
                                    <button class="btn btn-secondary copy-btn" onclick="event.stopPropagation(); copyToClipboard('${block.hash}')">Copiar Hash</button>
                                </div>
                            </div>
                            <div class="block-transactions" id="transactions-${block.index}">
                                ${block.transactions.map(tx => `
                                    <div class="transaction-detail">
                                        <div class="tx-hash">Hash: ${tx.hash}</div>
                                        <div class="tx-info-row">
                                            <span class="tx-label">De:</span>
                                            <span class="tx-value">${tx.sender}</span>
                                        </div>
                                        <div class="tx-info-row">
                                            <span class="tx-label">Para:</span>
                                            <span class="tx-value">${tx.recipient}</span>
                                        </div>
                                        <div class="tx-info-row">
                                            <span class="tx-label">Monto:</span>
                                            <span class="tx-value" style="color: #f0b90b; font-weight: bold;">${tx.amount_formatted || formatWei(tx.amount)}</span>
                                        </div>
                                        <div class="tx-info-row">
                                            <span class="tx-label">Fecha:</span>
                                            <span class="tx-value">${new Date(tx.timestamp).toLocaleString()}</span>
                                        </div>
                                        <button class="btn btn-secondary copy-btn" style="margin-top: 8px; font-size: 11px; padding: 4px 8px;" onclick="event.stopPropagation(); copyToClipboard('${tx.hash}')">Copiar Hash TX</button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                document.getElementById('blocks-list').innerHTML = html;
            } catch (error) {
                document.getElementById('blocks-list').innerHTML = 
                    `<div class="error">Error: ${error.message}</div>`;
            }
        }

        function toggleBlock(blockIndex) {
            const blockElement = document.getElementById(`block-${blockIndex}`);
            const transactionsElement = document.getElementById(`transactions-${blockIndex}`);
            const expandIcon = document.getElementById(`expand-icon-${blockIndex}`);
            
            if (blockElement.classList.contains('expanded')) {
                blockElement.classList.remove('expanded');
                expandIcon.textContent = '‚ñº';
            } else {
                blockElement.classList.add('expanded');
                expandIcon.textContent = '‚ñ≤';
            }
        }

        async function searchTransactionByHash() {
            const txHash = document.getElementById('search-tx-hash').value.trim();
            if (!txHash) {
                alert('Por favor ingresa el hash de la transacci√≥n');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/transaction/${txHash}`);
                if (!response.ok) {
                    if (response.status === 404) {
                        document.getElementById('tx-hash-result').innerHTML = 
                            '<div class="error">Transacci√≥n no encontrada</div>';
                        return;
                    }
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                const data = await response.json();
                const tx = data.transaction;
                
                document.getElementById('tx-hash-result').innerHTML = `
                    <div class="transaction-detail" style="margin-top: 20px;">
                        <div class="tx-hash"><strong>Hash de la Transacci√≥n:</strong><br>${tx.hash}</div>
                        <div class="tx-info-row">
                            <span class="tx-label">Bloque:</span>
                            <span class="tx-value">#${data.block_index} (Hash: ${data.block_hash.substring(0, 16)}...)</span>
                        </div>
                        <div class="tx-info-row">
                            <span class="tx-label">Fecha del Bloque:</span>
                            <span class="tx-value">${new Date(data.block_timestamp).toLocaleString()}</span>
                        </div>
                        <div class="tx-info-row">
                            <span class="tx-label">De (Remitente):</span>
                            <span class="tx-value">${tx.sender}</span>
                        </div>
                        <div class="tx-info-row">
                            <span class="tx-label">Para (Destinatario):</span>
                            <span class="tx-value">${tx.recipient}</span>
                        </div>
                        <div class="tx-info-row">
                            <span class="tx-label">Monto:</span>
                            <span class="tx-value" style="color: #f0b90b; font-weight: bold; font-size: 18px;">${tx.amount_formatted || formatWei(tx.amount)}</span>
                        </div>
                        <div class="tx-info-row">
                            <span class="tx-label">Fecha de la Transacci√≥n:</span>
                            <span class="tx-value">${new Date(tx.timestamp).toLocaleString()}</span>
                        </div>
                        <button class="btn btn-secondary copy-btn" style="margin-top: 12px;" onclick="copyToClipboard('${tx.hash}')">Copiar Hash</button>
                    </div>
                `;
            } catch (error) {
                document.getElementById('tx-hash-result').innerHTML = 
                    `<div class="error">Error: ${error.message}</div>`;
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('Copiado al portapapeles');
            });
        }

        async function connectMetaMask() {
            // Prevenir m√∫ltiples conexiones simult√°neas
            if (isConnecting) {
                console.log('Ya hay una conexi√≥n en proceso, esperando...');
                return;
            }

            if (typeof window.ethereum === 'undefined') {
                alert('MetaMask no est√° instalado. Por favor instala MetaMask para continuar.');
                return;
            }

            // Si ya est√° conectado, no hacer nada
            if (connectedAddress && authToken) {
                alert('Ya est√°s conectado con: ' + connectedAddress.substring(0, 6) + '...' + connectedAddress.substring(38));
                return;
            }

            isConnecting = true;
            const connectBtn = document.getElementById('connect-btn');
            if (connectBtn) {
                connectBtn.disabled = true;
                connectBtn.textContent = 'Conectando...';
            }

            try {
                // Primero verificar si ya hay cuentas conectadas
                let accounts = [];
                try {
                    accounts = await window.ethereum.request({ method: 'eth_accounts' });
                } catch (e) {
                    console.log('Error obteniendo cuentas existentes:', e);
                }

                // Si no hay cuentas conectadas, solicitar acceso
                if (!accounts || accounts.length === 0) {
                    try {
                        accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    } catch (error) {
                        // Si el usuario rechaza o hay un error, manejar apropiadamente
                        if (error.code === 4001) {
                            throw new Error('Conexi√≥n rechazada por el usuario');
                        } else if (error.message && error.message.includes('already pending')) {
                            throw new Error('Ya hay una solicitud pendiente. Por favor espera y vuelve a intentar.');
                        } else {
                            throw error;
                        }
                    }
                }

                const address = accounts[0];

                if (!address) {
                    throw new Error('No se pudo obtener la direcci√≥n de la wallet');
                }

                // Obtener mensaje para firmar
                const messageResponse = await fetch(`${API_BASE}/auth/message/${address}`);
                if (!messageResponse.ok) {
                    const error = await messageResponse.json();
                    throw new Error(error.detail || 'Error obteniendo mensaje de autenticaci√≥n');
                }
                const messageData = await messageResponse.json();

                // Solicitar firma del mensaje
                let signature;
                try {
                    signature = await window.ethereum.request({
                        method: 'personal_sign',
                        params: [messageData.message, address]
                    });
                } catch (error) {
                    if (error.code === 4001) {
                        throw new Error('Firma rechazada por el usuario');
                    } else {
                        throw error;
                    }
                }

                // Autenticarse con la firma
                const authResponse = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        address: address,
                        signature: signature,
                        message: messageData.message
                    })
                });

                if (!authResponse.ok) {
                    const error = await authResponse.json();
                    throw new Error(error.detail || 'Error en la autenticaci√≥n');
                }

                const authData = await authResponse.json();
                authToken = authData.access_token;
                connectedAddress = address.toLowerCase();

                // Guardar en localStorage
                localStorage.setItem('auth_token', authToken);
                localStorage.setItem('wallet_address', connectedAddress);

                updateWalletStatus();
                alert('MetaMask conectado exitosamente');
            } catch (error) {
                console.error('Error conectando MetaMask:', error);
                let errorMessage = 'Error desconocido';
                
                if (error.message) {
                    errorMessage = error.message;
                } else if (error.code === 4001) {
                    errorMessage = 'Conexi√≥n rechazada por el usuario';
                } else if (error.message && error.message.includes('already pending')) {
                    errorMessage = 'Ya hay una solicitud pendiente. Por favor espera unos segundos y vuelve a intentar.';
                }
                
                alert('Error: ' + errorMessage);
            } finally {
                isConnecting = false;
                if (connectBtn) {
                    connectBtn.disabled = false;
                    connectBtn.textContent = 'Conectar MetaMask';
                }
            }
        }

        function disconnectMetaMask() {
            authToken = null;
            connectedAddress = null;
            localStorage.removeItem('auth_token');
            localStorage.removeItem('wallet_address');
            updateWalletStatus();
            document.getElementById('authenticated-actions').style.display = 'none';
            alert('Desconectado exitosamente');
        }

        function updateWalletStatus() {
            const statusEl = document.getElementById('wallet-connected');
            const connectBtn = document.getElementById('connect-btn');
            const disconnectBtn = document.getElementById('disconnect-btn');
            const statusContent = document.getElementById('connection-status');
            const metamaskInfo = document.getElementById('metamask-info');
            const errorDiv = document.getElementById('connection-error');

            if (connectedAddress && authToken) {
                statusEl.textContent = `Conectado: ${connectedAddress.substring(0, 6)}...${connectedAddress.substring(38)}`;
                statusEl.style.color = '#0ecb81';
                if (connectBtn) {
                    connectBtn.style.display = 'none';
                    connectBtn.disabled = false;
                    connectBtn.textContent = 'Conectar MetaMask';
                }
                if (disconnectBtn) disconnectBtn.style.display = 'inline-block';
                statusContent.textContent = `Conectado: ${connectedAddress}`;
                statusContent.style.color = '#0ecb81';
                metamaskInfo.innerHTML = `
                    <div class="wallet-info">
                        <div class="stat-label">Direcci√≥n Conectada</div>
                        <div class="wallet-address">${connectedAddress}</div>
                    </div>
                `;
                document.getElementById('authenticated-actions').style.display = 'block';
                if (errorDiv) errorDiv.style.display = 'none';
            } else {
                statusEl.textContent = 'No conectado';
                statusEl.style.color = '#8a8fa3';
                if (connectBtn) {
                    connectBtn.style.display = 'inline-block';
                    connectBtn.disabled = typeof window.ethereum === 'undefined';
                }
                if (disconnectBtn) disconnectBtn.style.display = 'none';
                statusContent.textContent = 'No conectado';
                statusContent.style.color = '#8a8fa3';
                metamaskInfo.innerHTML = '';
            }
        }

        async function getMyBalance() {
            if (!authToken) {
                alert('Por favor conecta MetaMask primero');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/wallet/balance`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || 'Error obteniendo balance');
                }

                const data = await response.json();
                
                // Usar formatWei si balance_formatted no est√° disponible o est√° mal formateado
                let balanceDisplay = data.balance_formatted;
                if (!balanceDisplay || balanceDisplay.includes('E') || balanceDisplay.includes('e')) {
                    balanceDisplay = formatWei(data.balance || 0);
                }
                
                document.getElementById('my-balance-result').innerHTML = `
                    <div class="wallet-info">
                        <div class="stat-label">Direcci√≥n</div>
                        <div class="wallet-address">${data.address}</div>
                        <div class="stat-label">Balance</div>
                        <div class="balance-display">${balanceDisplay}</div>
                    </div>
                `;
            } catch (error) {
                console.error('Error obteniendo balance:', error);
                document.getElementById('my-balance-result').innerHTML = 
                    `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function transferFunds() {
            if (!authToken) {
                alert('Por favor conecta MetaMask primero');
                return;
            }

            const recipient = document.getElementById('transfer-recipient').value.trim();
            const amount = parseFloat(document.getElementById('transfer-amount').value);

            if (!recipient || !amount || amount <= 0) {
                alert('Por favor completa todos los campos correctamente');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/transactions/transfer`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        recipient: recipient,
                        amount: amount
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Error en la transferencia');
                }

                const data = await response.json();
                document.getElementById('transfer-result').innerHTML = `
                    <div class="success">
                        ‚úì Transacci√≥n creada exitosamente<br>
                        De: ${data.transaction.sender}<br>
                        Para: ${data.transaction.recipient}<br>
                        Monto: ${data.transaction.amount}
                    </div>
                `;
                
                // Limpiar campos
                document.getElementById('transfer-recipient').value = '';
                document.getElementById('transfer-amount').value = '';
            } catch (error) {
                document.getElementById('transfer-result').innerHTML = 
                    `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function getMyTransactions() {
            if (!authToken) {
                alert('Por favor conecta MetaMask primero');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/wallet/transactions`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Error obteniendo transacciones');
                }

                const data = await response.json();
                
                if (data.transactions.length === 0) {
                    document.getElementById('my-transactions-result').innerHTML = 
                        '<div class="loading">No hay transacciones</div>';
                    return;
                }

                let html = `<div style="margin-top: 20px;"><div class="stat-label">Total: ${data.count} transacciones</div>`;
                data.transactions.forEach(tx => {
                    const amountClass = tx.type === 'sent' ? 'sent' : 'received';
                    const sign = tx.type === 'sent' ? '-' : '+';
                    html += `
                        <div class="transaction-item">
                            <div>
                                <div class="tx-amount ${amountClass}">${sign}${tx.amount_formatted}</div>
                                <div class="tx-details">
                                    ${tx.type === 'sent' ? 'Para: ' + tx.recipient : 'De: ' + tx.sender}
                                    <br>Bloque: ${tx.block_index} | ${new Date(tx.timestamp).toLocaleString()}
                                    <br>Hash: ${tx.hash.substring(0, 16)}...
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                document.getElementById('my-transactions-result').innerHTML = html;
            } catch (error) {
                document.getElementById('my-transactions-result').innerHTML = 
                    `<div class="error">Error: ${error.message}</div>`;
            }
        }

        // Cargar info inicial y bloques al cargar la p√°gina
        loadChainInfo();
        loadBlocks();
        updateWalletStatus();
    </script>
</body>
</html>


